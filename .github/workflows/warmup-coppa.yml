name: Cache warmup (last/next/rankings) – Coppa

on:
  schedule:
    - cron: "0 4 * * *"     # copre 04:00 ITA estate+inverno
    - cron: "0 12 * * *"   # copre 12:00 ITA estate+inverno
  workflow_dispatch:

jobs:
  call-warmup-coppa:
    runs-on: ubuntu-latest

    steps:
      - name: Esegui solo se ORA ITA è 05:00 o 14:00
        run: |
          TZ="Europe/Rome"
          hour=$(TZ=$TZ date +%H)
          minute=$(TZ=$TZ date +%M)

          if [[ "$minute" != "00" ]]; then exit 0; fi
          if [[ "$hour" != "05" && "$hour" != "14" ]]; then
            echo "⛔ Ora ITA non valida: $hour:$minute — esco."
            exit 0
          fi

          echo "✅ Ora ITA valida ($hour:$minute), procedo."

      - name: Chiama /internal/cron/warmup-coppa
        env:
          BACKEND_BASE_URL: https://astro-league-hub-api.onrender.com
          CRON_SECRET: oC53qdSzDTW0VV0HrDHTmr8FD12C9rtFKEpvAAWL4UBYTiPCFojniACyQDoDsJqX
        run: |
          # (script identico a Campionato, cambiando l’endpoint)
          set -euo pipefail
          command -v jq >/dev/null 2>&1 || { sudo apt-get update; sudo apt-get install -y jq; }
          attempt=0
          max_attempts=3
          delay=3
          while (( attempt < max_attempts )); do
            attempt=$((attempt+1))
            echo "Tentativo $attempt/$max_attempts..."

            : > response.json
            http_code=$(
              curl -sS -X POST \
                -H "X-CRON-SECRET: ${CRON_SECRET}" \
                -H "Accept: application/json" \
                --connect-timeout 20 --max-time 300 \
                --fail-with-body \
                -o response.json -w "%{http_code}" \
                "${BACKEND_BASE_URL}/internal/cron/warmup-coppa" \
              || true
            )

            if [[ ! -s response.json ]]; then echo '{"success":false,"error":{"message":"no-body"}}' > response.json; fi

            status=$(jq -r 'if .success==true then (.data.status // "ok") else (.error.message // "error") end' response.json 2>/dev/null || echo "unknown")

            echo "HTTP ${http_code} — ${status}"

            {
              echo "### Cache warmup (Coppa)"
              echo "- HTTP: **${http_code}**"
              echo "- Status: \`${status}\`"
              echo "- Last count: $(jq -r '.data.sections.last_next.last_count // 0' response.json 2>/dev/null || echo 0)"
              echo "- Next count: $(jq -r '.data.sections.last_next.next_count // 0' response.json 2>/dev/null || echo 0)"
              echo "- Rankings count: $(jq -r '.data.sections.rankings.count // 0' response.json 2>/dev/null || echo 0)"
              echo ""
              echo "<details><summary>Payload</summary>"
              echo '```json'
              cat response.json
              echo '```'
              echo "</details>"
            } >> "$GITHUB_STEP_SUMMARY"

            if [[ "${http_code}" =~ ^(200|206|409)$ ]]; then
              echo ""
              echo "✅ Warmup Coppa OK"
              exit 0
            fi

            echo "⚠️ Warmup Coppa non riuscito — backoff ${delay}s..."
            sleep "${delay}"
            if (( delay < 30 )); then delay=$(( delay * 2 )); fi
          done

          echo "❌ Warmup Coppa fallito dopo ${max_attempts} tentativi"
          exit 1
